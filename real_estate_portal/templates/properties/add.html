{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
<style>
.map-container {
    height: 300px;
    border-radius: 10px;
    overflow: hidden;
}

.image-preview {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
}

.dropzone {
    border: 2px dashed var(--primary-color);
    border-radius: 10px;
    background: var(--light-gray);
    min-height: 150px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
}

.dropzone:hover {
    background: white;
}

.amenity-selector {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.amenity-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative; /* Added for proper positioning */
}

.amenity-item:hover {
    border-color: var(--primary-color);
    background: var(--light-gray);
}

.amenity-item.selected {
    background: rgba(0, 123, 255, 0.15); /* Lighter blue background */
    color: #0056b3; /* Darker blue text */
    border-color: #0056b3;
    font-weight: bold;
}

.amenity-item img, .amenity-item i {
    width: 24px;
    height: 24px;
    object-fit: contain;
    flex-shrink: 0; /* Prevent the icon from shrinking */
}

/* Add a checkmark for selected items */
.amenity-item.selected::after {
    content: "âœ“";
    position: absolute;
    right: 10px;
    color: #0056b3;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ 'Edit Property' if edit_mode else 'List Your Property' }}</h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="propertyForm" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <!-- Basic Details -->
                        <h5 class="mb-4">Basic Details</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.property_type(class="form-control", placeholder="Property Type") }}
                                    {{ form.property_type.label }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.property_category(class="form-control", placeholder="Property Category") }}
                                    {{ form.property_category.label }}
                                </div>
                            </div>
                        </div>

                        <!-- Location Details -->
                        <h5 class="mb-4">Location</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-12">
                                <div class="form-floating">
                                    {{ form.location(class="form-control", placeholder="Location") }}
                                    {{ form.location.label }}
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-floating">
                                    {{ form.address(class="form-control", placeholder="Address", style="height: 100px") }}
                                    {{ form.address.label }}
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Pin Location on Map</label>
                                <div class="map-container" id="map"></div>
                                {{ form.latitude(type="hidden", id="latitude") }}
                                {{ form.longitude(type="hidden", id="longitude") }}
                            </div>
                        </div>

                        <!-- Property Details -->
                        <h5 class="mb-4">Property Details</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.price(class="form-control", placeholder="Price") }}
                                    {{ form.price.label }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.carpet_area(class="form-control", placeholder="Carpet Area") }}
                                    {{ form.carpet_area.label }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.maintenance_charge(class="form-control", placeholder="Maintenance Charge") }}
                                    {{ form.maintenance_charge.label }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.listing_type(class="form-control", placeholder="Listing Type") }}
                                    {{ form.listing_type.label }}
                                </div>
                            </div>
                        </div>

                        <!-- Building Details -->
                        <h5 class="mb-4">Building Details</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.total_floors(class="form-control", placeholder="Total Floors") }}
                                    {{ form.total_floors.label }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.floor_number(class="form-control", placeholder="Floor Number") }}
                                    {{ form.floor_number.label }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.property_age(class="form-control", placeholder="Property Age") }}
                                    {{ form.property_age.label }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.facing(class="form-control", placeholder="Property Facing") }}
                                    {{ form.facing.label }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.overlooking(class="form-control", placeholder="Overlooking") }}
                                    {{ form.overlooking.label }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.furnishing_type(class="form-control", placeholder="Furnishing Type") }}
                                    {{ form.furnishing_type.label }}
                                </div>
                            </div>
                        </div>

                        <!-- Utilities -->
                        <h5 class="mb-4">Utilities</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.water_supply(class="form-control", placeholder="Water Supply") }}
                                    {{ form.water_supply.label }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.power_backup(class="form-control", placeholder="Power Backup") }}
                                    {{ form.power_backup.label }}
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <h5 class="mb-4">Description</h5>
                        <div class="mb-4">
                            <div class="form-floating">
                                {{ form.description(class="form-control", placeholder="Description", style="height: 150px") }}
                                {{ form.description.label }}
                            </div>
                        </div>

                        <!-- Amenities -->
                        <h5 class="mb-4">Amenities</h5>
                        <div class="amenity-selector mb-4">
                            {% set available_images = ['swimming-pool.png', 'gym.png', 'garden.png', 'Power Backup.png', '247 Security.png', 'Clubhouse.png', 'EV Charging.png'] %}
                            
                            {% set amenities_icons = {
                                '1': 'swimming-pool.png',
                                '2': 'gym.png',
                                '3': 'garden.png',
                                '4': 'placeholder.jpg',
                                '5': '247 Security.png',
                                '6': 'placeholder.jpg',
                                'Swimming Pool': 'swimming-pool.png',
                                'Gym': 'gym.png',
                                'Garden': 'garden.png',
                                'Landscaped Garden': 'garden.png',
                                'Security': '247 Security.png',
                                '24/7 Security': '247 Security.png',
                                'Power Backup': 'Power Backup.png',
                                'Clubhouse': 'Clubhouse.png',
                                'EV Charging': 'EV Charging.png'
                            } %}
                            
                            {% for value, label in form.amenities.choices %}
                            <div class="amenity-item" data-value="{{ value }}">
                                {% set icon_key = value|string %}
                                {% set icon_name = amenities_icons.get(icon_key) or amenities_icons.get(label) %}
                                {% if icon_name and icon_name in available_images %}
                                    <img src="{{ url_for('static', filename='images/properties/' ~ icon_name) }}" 
                                         alt="{{ label }}">
                                {% else %}
                                    <i class="bi bi-check-circle"></i>
                                {% endif %}
                                <span>{{ label }}</span>
                                <input type="checkbox" name="amenities" value="{{ value }}" 
                                       style="display: none;" class="amenity-checkbox">
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Property Images -->
                        <h5 class="mb-4">Property Images</h5>
                        <div class="dropzone mb-4" id="propertyImages">
                            <div class="dz-message">
                                <i class="bi bi-cloud-upload display-4 mb-3"></i>
                                <h5>Drop files here or click to upload</h5>
                                <p class="text-muted">Upload high-quality images of your property (Max 10 images)</p>
                            </div>
                        </div>

                        <!-- Additional Options -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.rera_registered(class="form-check-input") }}
                                    {{ form.rera_registered.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.ownership_type(class="form-control", placeholder="Ownership Type") }}
                                    {{ form.ownership_type.label }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.featured(class="form-check-input") }}
                                    {{ form.featured.label(class="form-check-label") }}
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script>
// Initialize map
const map = L.map('map').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// If we have lat/lng values from the form, use them
if(document.getElementById('latitude').value && document.getElementById('longitude').value) {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    
    map.setView([lat, lng], 13);
    marker = L.marker([lat, lng]).addTo(map);
}

let marker;
map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    
    if (marker) {
        marker.setLatLng([lat, lng]);
    } else {
        marker = L.marker([lat, lng]).addTo(map);
    }
});

// Initialize Dropzone
let propertyId;

// In edit mode, get property ID from the form action URL or hidden field
if (document.querySelector('form#propertyForm').action) {
    const actionUrl = document.querySelector('form#propertyForm').action;
    const matches = actionUrl.match(/\/property\/(\d+)\/edit/);
    if (matches && matches[1]) {
        propertyId = matches[1];
    }
}

// If we couldn't get it from the form action, try from URL parameters or path
if (!propertyId) {
    propertyId = new URLSearchParams(window.location.search).get('property_id') || 
                window.location.pathname.split('/').filter(p => p).pop();
}

// For debugging
console.log("Using propertyId for uploads:", propertyId);

// Determine upload URL based on whether we have a property ID
const uploadUrl = propertyId ? `/upload/${propertyId}` : '/upload/temp';
console.log("Upload URL:", uploadUrl);

// Initialize Dropzone with the correct URL
Dropzone.options.propertyImages = {
    url: uploadUrl,
    paramName: "file",
    maxFiles: 10,
    maxFilesize: 5,
    acceptedFiles: "image/*",
    addRemoveLinks: true,
    createImageThumbnails: true,
    init: function() {
        this.on("success", function(file, response) {
            console.log("Upload successful:", response);
            
            // Check if response is JSON object with imageUrl property
            if (response && response.imageUrl) {
                file.imageUrl = response.imageUrl;
            } else if (response && response.success && response.imageUrl) {
                file.imageUrl = response.imageUrl;
            } else if (typeof response === 'string') {
                try {
                    // Try to parse as JSON if it's a string
                    const parsedResponse = JSON.parse(response);
                    file.imageUrl = parsedResponse.imageUrl || parsedResponse.image_url;
                } catch (e) {
                    console.error("Failed to parse response:", e);
                }
            }
            
            // Add hidden input with image URL if available
            if (file.imageUrl) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'images[]';
                input.value = file.imageUrl;
                document.getElementById('propertyForm').appendChild(input);
            }
        });
        
        this.on("error", function(file, errorMessage) {
            console.error("Upload error:", errorMessage);
            let message = "Error uploading image";
            
            if (typeof errorMessage === 'string') {
                message = errorMessage;
            } else if (errorMessage && errorMessage.error) {
                message = errorMessage.error;
            }
            
            // Display error message
            alert("Error uploading image: " + message);
            
            // Add error styling to the file
            file.previewElement.classList.add('dz-error');
            const errorDisplay = file.previewElement.querySelector('.dz-error-message span');
            if (errorDisplay) {
                errorDisplay.textContent = message;
            }
        });
    }
};

// Better implementation of amenity selection
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded - setting up amenity handlers");
    
    // Pre-select already checked amenities
    document.querySelectorAll('.amenity-item').forEach(item => {
        const checkbox = item.querySelector('.amenity-checkbox');
        if (checkbox && checkbox.checked) {
            item.classList.add('selected');
            console.log(`Pre-selected amenity: ${checkbox.value}`);
        }
    });
    
    // Set up click handlers
    document.querySelectorAll('.amenity-item').forEach(item => {
        item.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const checkbox = this.querySelector('.amenity-checkbox');
            if (!checkbox) return false;
            
            // Toggle selection state
            const wasSelected = checkbox.checked;
            checkbox.checked = !wasSelected;
            
            // Update visual state
            if (checkbox.checked) {
                this.classList.add('selected');
            } else {
                this.classList.remove('selected');
            }
            
            console.log(`Amenity ${checkbox.value}: ${checkbox.checked ? 'Selected' : 'Unselected'}`);
            return false;
        };
    });
});

// Form validation
document.getElementById('propertyForm').addEventListener('submit', function(e) {
    const requiredFields = ['price', 'carpet_area', 'address'];
    let isValid = true;
    
    // Clean up numeric inputs - remove commas before submission
    const numericFields = ['price', 'carpet_area', 'maintenance_charge', 'total_floors', 'floor_number'];
    numericFields.forEach(fieldId => {
        const input = document.getElementById(fieldId);
        if (input && input.value) {
            // Remove any non-numeric characters except decimal point
            input.value = input.value.replace(/[^\d.]/g, '');
        }
    });
    
    requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (input && !input.value) {
            input.classList.add('is-invalid');
            isValid = false;
        } else if (input) {
            input.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields');
    }
});

// Price formatting
const priceInput = document.getElementById('price');
if (priceInput) {
    priceInput.addEventListener('input', function(e) {
        let value = this.value.replace(/[^\d]/g, '');
        if (value) {
            value = parseInt(value).toLocaleString('en-IN');
            this.value = value;
        }
    });
}
</script>
{% endblock %}