{% extends "base.html" %}

{% block styles %}
<style>
.loan-calculator {
    border-radius: 15px;
    box-shadow: var(--shadow);
    background: white;
}

.loan-summary {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    color: white;
    border-radius: 10px;
    padding: 2rem;
    margin: 1rem 0;
}

.detail-card {
    border-radius: 10px;
    border: 1px solid #eee;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: var(--transition);
}

.detail-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 2rem 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card loan-calculator">
                <div class="card-body">
                    <h3 class="card-title mb-4">Home Loan Calculator</h3>
                    
                    <!-- Loan Calculator Form -->
                    <form id="loanForm">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label">Loan Amount (₹)</label>
                                <input type="number" class="form-control" id="loanAmount" 
                                       placeholder="Enter loan amount" required min="100000">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Interest Rate (% per annum)</label>
                                <input type="number" class="form-control" id="interestRate" 
                                       placeholder="Enter interest rate" required step="0.01" min="1" max="30">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Loan Term (years)</label>
                                <input type="number" class="form-control" id="loanTerm" 
                                       placeholder="Enter loan term" required min="1" max="30">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Down Payment (₹)</label>
                                <input type="number" class="form-control" id="downPayment" 
                                       placeholder="Enter down payment amount" min="0">
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary w-100">Calculate EMI</button>
                            </div>
                        </div>
                    </form>

                    <!-- Results Section (initially hidden) -->
                    <div id="loanResults" style="display: none;">
                        <div class="loan-summary mt-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <h4 class="mb-3">Monthly EMI</h4>
                                    <h2 class="mb-3">₹<span id="monthlyEMI">0</span></h2>
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-6">
                                            <small>Principal Amount</small>
                                            <div>₹<span id="principalAmount">0</span></div>
                                        </div>
                                        <div class="col-6">
                                            <small>Total Interest</small>
                                            <div>₹<span id="totalInterest">0</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loan Details -->
                        <div class="mt-4">
                            <h5>Loan Breakup</h5>
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <div class="detail-card text-center">
                                        <h6>Total Payment</h6>
                                        <div class="h4 mb-0">₹<span id="totalPayment">0</span></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="detail-card text-center">
                                        <h6>Interest Component</h6>
                                        <div class="h4 mb-0"><span id="interestPercent">0</span>%</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="detail-card text-center">
                                        <h6>Principal Component</h6>
                                        <div class="h4 mb-0"><span id="principalPercent">0</span>%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chart -->
                        <div class="chart-container">
                            <canvas id="loanChart"></canvas>
                        </div>

                        <!-- Amortization Schedule -->
                        <div class="mt-4">
                            <h5>Amortization Schedule</h5>
                            <div class="table-responsive">
                                <table class="table table-striped" id="amortizationTable">
                                    <thead>
                                        <tr>
                                            <th>Year</th>
                                            <th>Principal Paid</th>
                                            <th>Interest Paid</th>
                                            <th>Total Payment</th>
                                            <th>Remaining Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Filled dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="mt-4">
                <h5>Understanding Home Loan EMI</h5>
                <p>EMI (Equated Monthly Installment) is calculated using the following formula:</p>
                <p><strong>EMI = P × r × (1 + r)^n / ((1 + r)^n - 1)</strong></p>
                <p>Where:</p>
                <ul>
                    <li>P = Principal loan amount</li>
                    <li>r = Interest rate per month [Annual rate ÷ 12 ÷ 100]</li>
                    <li>n = Total number of months [Years × 12]</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.getElementById('loanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        loanAmount: parseFloat(document.getElementById('loanAmount').value),
        interestRate: parseFloat(document.getElementById('interestRate').value),
        loanTerm: parseInt(document.getElementById('loanTerm').value),
        downPayment: parseFloat(document.getElementById('downPayment').value) || 0
    };
    
    // Calculate EMI
    const principal = formData.loanAmount - formData.downPayment;
    const monthlyRate = formData.interestRate / 12 / 100;
    const totalMonths = formData.loanTerm * 12;
    
    const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) / 
                (Math.pow(1 + monthlyRate, totalMonths) - 1);
    
    const totalPayment = emi * totalMonths;
    const totalInterest = totalPayment - principal;
    
    // Update results
    document.getElementById('monthlyEMI').textContent = emi.toFixed(2);
    document.getElementById('principalAmount').textContent = principal.toLocaleString();
    document.getElementById('totalInterest').textContent = totalInterest.toLocaleString();
    document.getElementById('totalPayment').textContent = totalPayment.toLocaleString();
    document.getElementById('interestPercent').textContent = ((totalInterest / totalPayment) * 100).toFixed(1);
    document.getElementById('principalPercent').textContent = ((principal / totalPayment) * 100).toFixed(1);
    
    // Generate amortization schedule
    generateAmortizationSchedule(principal, monthlyRate, totalMonths, emi);
    
    // Update chart
    updateChart(principal, totalInterest);
    
    // Show results
    document.getElementById('loanResults').style.display = 'block';
    
    // Smooth scroll to results
    document.getElementById('loanResults').scrollIntoView({ behavior: 'smooth' });
});

function generateAmortizationSchedule(principal, monthlyRate, totalMonths, emi) {
    let balance = principal;
    let yearlyData = [];
    let currentYear = {
        principalPaid: 0,
        interestPaid: 0,
        totalPayment: 0
    };
    
    const tbody = document.getElementById('amortizationTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
    
    for (let month = 1; month <= totalMonths; month++) {
        const interestPayment = balance * monthlyRate;
        const principalPayment = emi - interestPayment;
        
        currentYear.principalPaid += principalPayment;
        currentYear.interestPaid += interestPayment;
        currentYear.totalPayment += emi;
        
        balance -= principalPayment;
        
        if (month % 12 === 0 || month === totalMonths) {
            yearlyData.push({
                year: Math.ceil(month / 12),
                principalPaid: currentYear.principalPaid,
                interestPaid: currentYear.interestPaid,
                totalPayment: currentYear.totalPayment,
                balance: balance > 0 ? balance : 0
            });
            
            currentYear = {
                principalPaid: 0,
                interestPaid: 0,
                totalPayment: 0
            };
        }
    }
    
    // Populate table
    yearlyData.forEach(data => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = data.year;
        row.insertCell(1).textContent = '₹' + data.principalPaid.toLocaleString(undefined, {maximumFractionDigits: 0});
        row.insertCell(2).textContent = '₹' + data.interestPaid.toLocaleString(undefined, {maximumFractionDigits: 0});
        row.insertCell(3).textContent = '₹' + data.totalPayment.toLocaleString(undefined, {maximumFractionDigits: 0});
        row.insertCell(4).textContent = '₹' + data.balance.toLocaleString(undefined, {maximumFractionDigits: 0});
    });
}

function updateChart(principal, totalInterest) {
    const ctx = document.getElementById('loanChart').getContext('2d');
    
    if (window.loanChart) {
        window.loanChart.destroy();
    }
    
    window.loanChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Principal', 'Interest'],
            datasets: [{
                data: [principal, totalInterest],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>
{% endblock %}